---
title: NAT란 무엇인가
date: 2022-12-02
tags: [nat, firewall, slb]
---
어느 분의 "NAT를 가장 잘 이용하는 방법은 가능하면 사용하지 않는 것이다.[^1]"라는 말에 NAT가 얼마나 멋진(?) 아이디어인지 얘기해보고 싶었다.

NAT, Network Adress Translation은 내부에서 사용하던 IP를 외부와 통신할 때, 외부에서 통신할 수 있는 IP로 바꿔치기 하는 것이다. 마치 한국에서 원화를 쓰다가 외국 여행을 가면서 그 나라 통화로 환전하는 것이나, 구내전화번호는 간단하게 쓰다가 외부와의 통화가 필요하면 긴 번호로 변경하듯 말이다.

NAT가 1993년 처음 개발된 이유는 IPv4의 호스트 주소 갯수가 적어서 사람들로 하여금 사설 IP를 쓰도록 유도하기 위함이었다고 한다.[^2] 1994년 NAT를 주요 기능으로 하는 PIX (Private Internet Exchange)가 개발되었고, 당시 IP를 구입하지 않고서 로컬 네트웍에 할당했던 관례로 인해 인터넷에 연결할 수 없었던 기관들에게 희소식이었기에 엄청난 성공을 할 수 있었다고 한다.

IP 대 IP의 변환은 한계가 있다. 아무리 공인 IP 여러 개를 둔다고 해도, 동시에 변환해야 할 사설 IP가 많아지면, 공인 IP 갯수도 많아질 수 밖에 없다. 그래서 IP header뿐만 아니라 TCP/UDP header를 분해하여 포트 번호까지 이용한다.[^3]

이러한 NAT/PAT에 ACL 기능을 더한 것이 지금의 네트웍 방화벽의 주요 기능이다. 그런데, NAT는 여기서 그치지 않는다.

예전 네트웍 수업에서 가상의 프로젝트를 수행하게 되었었는데[^4], 그 프로젝트의 고객사는 금융사였고, 실전 경험 없이 현실의 네트웍을 구상하다보니 나온 고민 중 하나가 주요 대고객 서버들의 load를 분산해주는 것이었다. 고민을 하다 보니 라우터에 평소 사용하는 1:many NAT를 거꾸로 만들면 해결이 가능할 것 같았다. 그런데 Dynamips에서 구현 가능한 1:many NAT는 출발지를 변환하는 것만 가능했었다. 여기 저기 사이트에 질의한 결과 답을 찾을 수 없었고, 수업을 해주시던 강사님께 문의를 드렸더니 L4 slb를 알려주셨었다.

현재의 L4는 로드밸런싱을 하거나 프록시를 이용할 때, NAT를 사용한다.[^5] 즉, 지금으로선 NAT를 사용하지 않고 소비자 서비스용 네트웍을 만들긴 어렵다고 보면 된다.

[^1]: The best way to use NAT is to avoid it wherever you can.

[^2]: 2015년 CCR에 게재된 Paul Francis의 글[Network Address Translation](http://www.sigcomm.org/node/3761){:target="_blank"}{:rel="noopener noreferrer"}에 따르면 그가 NAT를 개발한 이유가 그렇다고 한다.

[^3]: PAT, Port Address Translation

[^4]: 6개월 동안 네트웍 전반을 배워야 하는 코스였고, 초반 3개월이 끝난 후, 모든 조는 그동안 배운 것들을 총동원해서 각자의 프로젝트를 완성해야 했다. 그땐 아직 BGP도 모를 때였다.

[^5]: 최근에 많이 사용되는 DSR(direct server return)은 NAT를 없애버렸지만, 아직 DSR이 완전히 정착되진 않아서 솔루션 중에는 DSR을 제대로 지원하지 못하는 경우도 있다. DSR은 빠르기도 하지만, 서버가 클라이언트에 응답 줄 때, L4를 거칠 필요가 없기에 동일 네트웍 대역과의 통신에서도 프록시를 사용할 필요가 없는 등 네트웍 설정을 간단하게 해준다. 다만, 서버에서는 설정을 해줘야 할 것이 있으며, 패킷 후처리를 해줘야 하는 기능이 있으면 사용할 수 없다.